name: Infrastructure Assessment Pipeline

on:
  push:
    branches:
      - dev
      - stage
      - prod
  schedule:
    - cron: "0 2 * * *"   # Daily backup schedule
  workflow_dispatch: {}   # Manual trigger support

jobs:

  ############################################################
  # STAGE 1 — BACKUP (Scheduled Daily + Before Migration)
  ############################################################
  backup:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'push'

    env:
      OTC_DEV_PASS: ${{ secrets.OTC_DEV_PASS }}
      GPS_DEV_PASS: ${{ secrets.GPS_DEV_PASS }}
      OTC_STAGING_PASS: ${{ secrets.OTC_STAGING_PASS }}
      GPS_STAGING_PASS: ${{ secrets.GPS_STAGING_PASS }}
      OTC_PROD_PASS: ${{ secrets.OTC_PROD_PASS }}
      GPS_PROD_PASS: ${{ secrets.GPS_PROD_PASS }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run backups for all envs
        run: bash automations/backup.sh

      - name: Upload backup artifacts
        uses: actions/upload-artifact@v4
        with:
          name: db-backups
          path: automations/backups/

  ############################################################
  # STAGE 2 — VALIDATION (Ephemeral QA + Check Backup Integrity)
  ############################################################
  validate:
    runs-on: ubuntu-latest
    needs: backup
    if: github.event_name == 'push'

    env:
      OTC_DEV_PASS: ${{ secrets.OTC_DEV_PASS }}
      GPS_DEV_PASS: ${{ secrets.GPS_DEV_PASS }}
      OTC_STAGING_PASS: ${{ secrets.OTC_STAGING_PASS }}
      GPS_STAGING_PASS: ${{ secrets.GPS_STAGING_PASS }}
      OTC_PROD_PASS: ${{ secrets.OTC_PROD_PASS }}
      GPS_PROD_PASS: ${{ secrets.GPS_PROD_PASS }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Spin up ephemeral QA env
        run: bash automations/create-ephemeral-qa.sh 1

      - name: Validate Database Backups
        run: bash automations/validate.sh

  ############################################################
  # STAGE 3 — MIGRATION WITH PRE/POST VALIDATION
  ############################################################
  migrate:
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push'

    env:
      OTC_DEV_PASS: ${{ secrets.OTC_DEV_PASS }}
      GPS_DEV_PASS: ${{ secrets.GPS_DEV_PASS }}
      OTC_STAGING_PASS: ${{ secrets.OTC_STAGING_PASS }}
      GPS_STAGING_PASS: ${{ secrets.GPS_STAGING_PASS }}
      OTC_PROD_PASS: ${{ secrets.OTC_PROD_PASS }}
      GPS_PROD_PASS: ${{ secrets.GPS_PROD_PASS }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run migration scripts
        id: migrate_step
        continue-on-error: true
        run: |
          echo "Running migration..."
          # Placeholder for migration commands:
          false  # Simulating failure for visibility

      - name: Post-Migration Verification
        if: steps.migrate_step.outcome == 'success'
        run: echo "Migration completed successfully!"

  ############################################################
  # STAGE 4 — AUTOMATED ROLLBACK ON FAILURE
  ############################################################
  rollback:
    runs-on: ubuntu-latest
    needs: migrate
    if: needs.migrate.result == 'failure'

    env:
      OTC_DEV_PASS: ${{ secrets.OTC_DEV_PASS }}
      GPS_DEV_PASS: ${{ secrets.GPS_DEV_PASS }}
      OTC_STAGING_PASS: ${{ secrets.OTC_STAGING_PASS }}
      GPS_STAGING_PASS: ${{ secrets.GPS_STAGING_PASS }}
      OTC_PROD_PASS: ${{ secrets.OTC_PROD_PASS }}
      GPS_PROD_PASS: ${{ secrets.GPS_PROD_PASS }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Roll back database using last backup
        run: |
          echo "Migration failed. Rolling back..."
          bash automations/backup.sh
          echo "Rollback completed."

  ############################################################
  # STAGE 5 — SECURITY SCANNING (SECRET DETECTION)
  ############################################################
  secret-scan:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Gitleaks secret scan
        uses: zricethezav/gitleaks-action@v2
        with:
          config: ""
